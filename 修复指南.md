# 代码分享网站修复指南

## 问题诊断

根据截图分析，主要问题是：
1. **RLS策略冲突**：注册时无法创建 `user_profiles` 表记录
2. **429错误**：频繁注册请求被限制
3. **401错误**：未授权访问

## 修复步骤

### 步骤1：在Supabase中运行SQL脚本

1. 打开Supabase控制台 (https://supabase.com)
2. 进入你的项目 `LMK-1018's Project lmk - 1018的项目`
3. 点击左侧菜单的 **SQL Editor**
4. 点击 **New query**
5. 复制 `supabase_rls_fix.sql` 文件中的内容
6. 粘贴到查询编辑器中
7. 点击 **Run** 按钮执行

### 步骤2：更新前端代码

用修复后的脚本替换原脚本：

1. **备份原文件**（可选）：
   ```
   script.js → script.js.backup
   ```

2. **应用修复**：
   ```
   script_fixed.js → script.js
   ```

   或者在 `index.html` 中修改引用：
   ```html
   <script src="script_fixed.js"></script>
   ```

### 步骤3：创建管理员用户资料

在Supabase SQL Editor中运行以下命令为管理员创建资料：

```sql
-- 插入管理员用户资料
INSERT INTO public.user_profiles (id, username, email)
SELECT 
    auth.users.id,
    '管理员',
    '2706273423@qq.com'
FROM auth.users 
WHERE auth.users.email = '2706273423@qq.com'
ON CONFLICT (id) DO UPDATE SET
    username = '管理员',
    email = '2706273423@qq.com';
```

### 步骤4：测试登录

1. 打开本地测试页面
2. 使用管理员账号登录：
   - **邮箱**：2706273423@qq.com
   - **密码**：20061018lmk.
3. 验证：
   - 是否能看到"添加网站"按钮
   - 是否能添加新网站
   - 其他用户是否能查看网站列表

### 步骤5：重新部署到Netlify

1. **本地测试通过后**，将修改后的文件提交到Git：
   ```bash
   git add .
   git commit -m "Fix RLS policies and user authentication"
   git push
   ```

2. **Netlify会自动重新部署**
   - 等待构建完成
   - 检查部署日志是否有错误
   - 测试在线版本

## 预期功能

修复后：
- **管理员** (2706273423@qq.com)：
  - 可以登录
  - 可以添加/删除网站
  - 可以查看所有用户信息
  
- **普通用户**：
  - 可以注册和登录
  - 可以查看网站列表
  - 不能添加/删除网站

- **匿名访客**：
  - 可以查看网站列表（通过直接访问网页）

## 故障排除

### 如果仍然遇到问题

1. **检查浏览器控制台错误**
   - F12 打开开发者工具
   - 查看 Console 标签页
   - 截图错误信息

2. **验证Supabase配置**
   - 确保URL和Anon Key正确
   - 确保表已创建
   - 确保RLS策略已应用

3. **清除浏览器缓存**
   - Ctrl+Shift+Del 清除缓存
   - 重新加载页面

4. **查看Netlify部署日志**
   - 登录Netlify控制台
   - 进入你的网站
   - 查看 Deploy log

## 账号信息

- **管理员邮箱**：2706273423@qq.com
- **管理员密码**：20061018lmk.
- **Supabase项目**：iyuqwappixlzveulkmhp

## 重要提醒

1. **不要泄露Anon Key**：这是公开的客户端密钥，但请确保不将其用于服务端
2. **定期备份数据**：在Supabase控制台中导出重要数据
3. **监控使用量**：免费版有每月请求限制
